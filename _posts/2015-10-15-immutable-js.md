---
layout: post
title:  "immutable.jsä½¿ç”¨å°ç»“"
date:   2015-10-15 20:48:28
categories: posts
tags: immutable
---
æœ€è¿‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº† `immutable.js` ä½œä¸ºæ•°æ®å±‚çš„æ–¹æ¡ˆã€‚å®ƒæ€»æ˜¯ä½œä¸º `react` çš„æ€§èƒ½ä¼˜åŒ–æ–¹æ¡ˆè¢«äººæèµ·ã€‚äº‹å®ä¸Šï¼Œå®ƒæ˜¯ç‹¬ç«‹çš„ä¸€ä¸ªåº“ï¼Œå¹¶ä¸ä¾èµ–äº `react` æˆ–è€…å…¶ä»–ç¬¬ä¸‰æ–¹åº“ã€‚<!-- more -->å®ƒçš„ä½œè€…æ˜¯ `FB` çš„ [Lee Byron][lee's twitter]ï¼Œä»–ä¹Ÿæ˜¯ [GraphQL][graphql] é¡¹ç›®çš„ä¸»è¦è´¡çŒ®è€…ä¹‹ä¸€ã€‚

æœ€ååšå®Œä¸€ä¸ªé¡¹ç›®ä¹‹åï¼Œæˆ‘æœ€å¤§çš„ä¸€ä¸ªä½“ä¼šæ˜¯ï¼ŒæŠ›å¼€ `immutable data` åœ¨ `react` æ€§èƒ½ä¼˜åŒ–ä¸­çš„ä¼˜åŠ¿ä¸è¯´ï¼Œä»…ä»…æ˜¯å®ƒæä¾›çš„ä¸€ç³»åˆ—å¼ºå¤§çš„æ•°æ®æ“ä½œ APIï¼Œå°±è®©æˆ‘çŒ®å‡ºè†ç›–äº†â€¦â€¦å—¯ï¼Œæ‰€ä»¥ä¸‹é¢ä¹Ÿä¼šæ€»ç»“å‡ ä¸ªæˆ‘æœ€å¸¸ç”¨åˆ°çš„ APIï¼Œæ¯•ç«Ÿå®ƒçš„[æ–‡æ¡£][doc]å†™å¾—éå¸¸çš„æ™¦æ¶©ï¼Œä»¥æ­¤çºªå¿µå‡ ä¸ªæœˆå‰æˆ‘å•ƒé‚£æ–‡æ¡£æ—¶çš„ç—›è‹¦æ—¶å…‰â€¦â€¦

---

## ä¸º javascript å¸¦æ¥ä¸å¯å˜æ•°æ®

`immutable data` å³ **ä¸å¯å˜æ•°æ®** ï¼Œå®ƒæ˜¯å‡½æ•°å¼ç¼–ç¨‹é‡Œä¸å¯æˆ–ç¼ºçš„é‡è¦è§’è‰²ã€‚è™½ç„¶æˆ‘ä»¬å¯ä»¥åœ¨ `javascript` ä¸­æ¨¡æ‹Ÿä¸€äº›å‡½æ•°å¼ç”¨æ³•ï¼Œä½†è¯´åˆ°åº•ï¼Œ`javascript` å¹¶ä¸æ˜¯å‡½æ•°å¼è¯­è¨€ã€‚ä¸å¯å˜æ•°æ®å¦‚æ­¤é‡è¦ï¼Œä»¥è‡´æœ‰äººå·²ç»åœ¨è®¨è®ºå°†å…¶åŠ å…¥æ ‡å‡†çš„å¯èƒ½æ€§ã€‚é‚£ä¸å¯å˜æ•°æ®åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬å…ˆçœ‹çœ‹ `javascript` ä¸­çš„å¯¹è±¡ï¼š

{% highlight javascript %}
var a = { name: 1 }
var b = a
b.name = 2
// 2
console.log(a.name)
{% endhighlight %}

æ˜¯çš„ï¼Œ`javascript` ä¸­çš„å¯¹è±¡æ˜¯å¼•ç”¨ç±»å‹çš„ã€‚è¿™æœ‰å®ƒçš„å¥½å¤„ï¼Œæ¯”å¦‚èŠ‚çœå†…å­˜ï¼ˆè™½ç„¶å†…å­˜è¶Šæ¥è¶Šä¸å€¼é’±äº†ğŸ˜¢ï¼‰ã€‚ä½†åœ¨å®é™…å¼€å‘ä¸­ï¼Œæˆ‘ä»¬å¾€å¾€å‘ç°ï¼Œå¯å˜çš„æ•°æ®å¸¦æ¥çš„åå¤„è¿œè¿œå¤§äºå¥½å¤„ã€‚ç”±äºæ˜¯å¼•ç”¨ç±»å‹çš„ï¼Œä¿®æ”¹æ•°æ®çš„æ—¶å€™éƒ½å˜å¾—å°å¿ƒç¿¼ç¿¼ï¼Œä¸çŸ¥é“ä¼šå¼•èµ·ä»€ä¹ˆè¿é”ååº”ã€‚

è€Œä¸å¯å˜æ•°æ®ï¼Œä¸€æ—¦åˆ›å»ºï¼Œå®ƒä¾¿ä¸å¯æ”¹å˜ã€‚å¯ä»¥è¿™æ ·ç†è§£å®ƒï¼šå¯¹ä¸å¯å˜æ•°æ® A ä½œä¸€ä¸ªæ›´æ”¹ï¼Œä½ å°†å¾—åˆ°ä¸€ä¸ªæ–°çš„æ›´æ”¹è¿‡çš„æ•°æ® Bï¼ŒåŒæ—¶ï¼ŒB å’Œ A å…±äº«ç€æ²¡æœ‰å‘ç”Ÿæ”¹å˜çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚çœ‹ä»£ç ï¼š

{% highlight javascript %}
import Immutable from 'immutable'

var a = Immutable.fromJS({
    name: 1
})
var b = a.set('name', 2)

// { name: 1 }
console.log(a.toJS())
// { name: 2 }
console.log(b.toJS())
{% endhighlight %}

`a` ä¸€æ—¦åˆ›å»ºä¹‹åï¼Œå¯¹å®ƒçš„ä»»ä½•ä¿®æ”¹éƒ½è¿”å›ä¸€ä¸ªæ–°çš„ `immutable data`ï¼Œè€Œä¸ä¼šå½±å“åˆ° `a` æœ¬èº«ã€‚

å½“ç„¶äº†ï¼Œè¿™ä¸ªä¾‹å­ï¼Œç”¨åŸç”Ÿçš„ `javascript` ä¹Ÿå¯ä»¥å®ç°ï¼š

{% highlight javascript %}
var a = {
    name: 1
}

var b = {
    ...a,
    name: 2
}

// { name: 1 }
console.log(a)
// { name: 2 }
console.log(b)
{% endhighlight %}

å¥½åƒçœ‹èµ·æ¥ï¼Œè¿˜æ›´ç®€å•â€¦â€¦å…¶å®ä¸ç„¶ã€‚è¿™é‡Œç”¨äº† es6 çš„è¯­æ³• `...a`ï¼Œå…¶å®ç›¸å½“äº `var b = Object.assign({}, a, { name: 2 })`ï¼Œæœ¬è´¨åªæ˜¯æµ…åº¦å¤åˆ¶ã€‚è¿™æ„å‘³ç€ï¼Œå¦‚æœä½ çš„æ•°æ®æ˜¯åµŒå¥—å¾ˆæ·±çš„ç»“æ„ï¼Œä½ å¤åˆ¶çš„ä»…ä»…æ˜¯å¼•ç”¨ã€‚è§£å†³çš„åŠæ³•æ˜¯ï¼Œå¯¹æ•°æ®è¿›è¡Œæ·±å†éå†å¤åˆ¶ã€‚ä½†è¿™æ ·åšæ˜¾ç„¶æœ‰ä¸¤ä¸ªç¼ºç‚¹ï¼š1ã€å¾ˆæ…¢ï¼›2ã€å¾ˆéº»çƒ¦ã€‚

`immutable.js` å®ç°çš„æ•°æ®ä¸å¯å˜ï¼Œè¡¨é¢ä¸Šçœ‹èµ·æ¥ï¼Œå¥½åƒä¹Ÿç»™äººä¸€ç§å¾ˆæ…¢çš„æ„Ÿè§‰ã€‚æˆ‘ä»¬çœ‹çœ‹å¼•ç”¨è‡ªå®˜æ–¹æ–‡æ¡£çš„ä¸€æ®µè¯ï¼š

> These data structures are highly efficient on modern JavaScript VMs by using structural sharing via hash maps tries and vector tries as popularized by Clojure and Scala, minimizing the need to copy or cache data.

å®ƒä½¿ç”¨äº† `Clojure` å’Œ `Scale` ï¼ˆè¿™ä¸¤è€…éƒ½æ˜¯å‡½æ•°å¼è¯­è¨€ï¼‰ä¸­å¸¸è§çš„ `hash map tries` ä»¥åŠ `vector tries` æ¥ä¿è¯å®ƒçš„æ•ˆç‡ï¼Œé¿å…äº†ä¸å¿…è¦çš„æ•°æ®å¤åˆ¶æˆ–æ•°æ®ç¼“å­˜ã€‚å…¶å†…éƒ¨çš„æ•°æ®ç»“æ„å®ç°åŸç†ï¼Œæƒ³æ·±å…¥äº†è§£çš„è¯ï¼Œå¯ä»¥å‚è€ƒè¿™ä¸ª[Persistent data structure][wiki]ã€‚

---

## ä¸ react çš„ç»“åˆ

`react` çš„å‡ºç°ï¼Œè®©äººä»¬é‡æ–°å…³æ³¨èµ·äº†å‡½æ•°å¼ç¼–ç¨‹ã€‚æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥çœ‹å¾… `react` ç»„ä»¶ï¼š**ç»„ä»¶æ˜¯ä¸€ä¸ªçº¯å‡½æ•°(pure function)ï¼Œå®ƒæ¥æ”¶ä¸€äº›æ•°æ®ä½œä¸ºå‚æ•°(props)ï¼Œè¿”å›ä¸€æ®µ `HTML`(è¿”å›çš„å…¶å®æ˜¯ä»£è¡¨ç€ä¸€æ®µ `HTML` çš„ `virtual DOM` )** ã€‚

æˆ‘ä»¬æ³¨æ„åˆ°äº† **çº¯å‡½æ•°** è¿™æ ·çš„ä¸€ä¸ªæ¦‚å¿µã€‚ä½ å¯ä»¥è¿™æ ·ç®€å•ç†è§£å®ƒï¼š**å¯¹äºçº¯å‡½æ•°æ¥è¯´ï¼Œåªè¦è¾“å…¥ï¼ˆè°ƒç”¨å‡½æ•°çš„å‚æ•°ï¼‰ä¸å˜ï¼Œå³è¾“å‡ºï¼ˆå‡½æ•°çš„è°ƒç”¨ç»“æœï¼‰ä½•æŒä¸å˜**ã€‚çœ‹ä¸¤ä¸ªä¾‹å­ï¼š

{% highlight javascript %}
// pure
function pure(a, b) {
    return a + b
}

// side effect
function notPure(a, b) {
    return a + b + Math.random()
}
{% endhighlight %}

å¾ˆæ˜¾ç„¶çš„ï¼Œç¬¬ä¸€ä¸ªå‡½æ•°æ˜¯ä¸ªçº¯å‡½æ•°ã€‚ç¬¬äºŒä¸ªåˆ™ä¸ç„¶ï¼Œå› ä¸ºå®ƒæœ‰å‰¯ä½œç”¨(side effect)ï¼Œæ¯æ¬¡è°ƒç”¨çš„ç»“æœéƒ½ä¸åŒã€‚

å‰é¢æåˆ°ï¼Œå¯ä»¥å°† `react` ç»„ä»¶çœ‹æˆä¸€ä¸ªçº¯å‡½æ•°ã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ¦‚å¿µæŠ½è±¡æˆè¿™æ ·ï¼š

{% highlight javascript %}
HTML = fComponent(props)
{% endhighlight %}

æˆ‘ä»¬çŸ¥é“ï¼Œè°ƒç”¨ç»„ä»¶çš„ `setState`ï¼Œæ€»æ˜¯ä¼šè§¦å‘ `re-render`ï¼Œå“ªæ€•ä½ çš„ `state` å®é™…ä¸Šå¹¶æ²¡æœ‰æ”¹å˜ã€‚

{% highlight javascript %}
class Demo extends React.Component {
    constructor() {
        super()
        this.state = {
            name: 'test'
        }
    }

    onChange = () => {
        // è¿™ä¼šè§¦å‘ç»„ä»¶çš„ `re-render`
        this.setState({
            name: 'test'
        })
    }

    render() {
       ...
    }
}
{% endhighlight %}

æˆ‘ä»¬å½“ç„¶æœŸæœ›å¯ä»¥é¿å…è¿™äº›ä¸å¿…è¦çš„ `re-render`ã€‚æ‰€å¹¸ `react` æä¾›çš„ä¸€ä¸ªç»„ä»¶ç”Ÿå‘½å‘¨æœŸæ–¹æ³• `shouldComponentUpdate` å¯ä»¥è®©æˆ‘ä»¬æ§åˆ¶ç»„ä»¶çš„ `re-render` é€»è¾‘ï¼Œå¯ä»¥åœ¨å…¶ä¸­å¯¹ç»„ä»¶å‰ã€åä¸¤æ¬¡æ¥æ”¶åˆ°çš„æ•°æ®è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœæ•°æ®ä¸€è‡´ï¼Œåˆ™è·³è¿‡ç»„ä»¶çš„é‡æ¸²æŸ“é˜¶æ®µã€‚

ç„¶è€Œäº‹ä»¶çœŸçš„è¿™ä¹ˆç®€å•å—ï¼Ÿè€ƒè™‘ä¸‹é¢çš„ä»£ç ï¼š

{% highlight javascript %}
var stateA = {
    name: 'immutable',
    obj: {
        a: 1
    }
}

var stateB = {
    name: 'immutable',
    obj: {
        a: 1
    }
}
{% endhighlight %}

ä¸Šé¢è¿™ä¸¤ä¸ªæ•°æ®å†…å®¹ä¸€è‡´ï¼Œå¯¹å®ƒä»¬çš„æ¯ä¸ªå±æ€§è¿›è¡Œæ¯”è¾ƒï¼Œä»¥æœŸè·³è¿‡ `re-render`ï¼Œä½†ç»“æœæ˜¯ `stateA.obj !== stateB.obj` ã€‚å½“ç„¶ï¼Œè¿™ç§ç»“æœå¹¶ä¸å‡ºä¹æˆ‘ä»¬çš„æ„æ–™ï¼Œæ¯•ç«Ÿè¿™æ˜¯ `javascript` å¯¹è±¡æ­£å¸¸çš„è¡Œä¸ºã€‚çœ‹èµ·æ¥ï¼Œä¼¼ä¹éœ€è¦è¿›è¡Œæ·±åº¦éå†æ¯”è¾ƒ(deep compare)â€¦â€¦

è·Ÿå‰é¢æåˆ°çš„ä¸€æ ·ï¼Œæ— è®ºæ˜¯æ·±åº¦æ‹·è´æ•°æ®ï¼Œæˆ–æ˜¯æ·±åº¦å¯¹æ¯”æ•°æ®ï¼Œæ‰§è¡Œèµ·æ¥çš„æ•ˆç‡éƒ½ä¼šå¾ˆæ…¢ã€‚è¿™ä¸ªæ—¶å€™ï¼Œä¸»è§’ `immutable.js` ç™»åœºäº†ã€‚å®ƒæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„åº“ï¼Œä½†ä½ ä¼šå‘ç°å®ƒè·Ÿ `react` ç®€ç›´æ˜¯ç»é…ã€‚

{% highlight javascript %}
import { fromJS, is } from 'immutable'

const stateA = fromJS({
    name: 'immutable',
    obj: {
        a: 1ï¼Œ
        b: {
            c: 0
        }
    }
})

const stateB = fromJS({
    name: 'immutable',
    obj: {
        a: 1,
        b: {
            c: 0
        }
    }
})

// ä¸¤ä¸ªç‹¬ç«‹çš„ä¸å¯å˜æ•°æ®
assert(stateA !== stateB)
// ä½†å†…å®¹ä¸€è‡´ï¼ŒImmutable.is
assert(is(stateA, stateB) === true)

// å…±äº«æ²¡å‘ç”Ÿå˜åŒ–çš„æ•°æ®
const stateC = stateA.set('name', 'changed name')

assert(is(stateA, stateC) === false)
// ç›´æ¥å¯¹æ¯”å¼•ç”¨ï¼
assert(stateA.get('obj') === stateC.get('obj'))
{% endhighlight %}

æ³¨æ„æœ€åä¸€è¡Œï¼Œ`assert(stateA.get('obj') === stateC.get('obj'))`ã€‚è™½ç„¶ `obj` å¯¹è±¡é‡Œé¢è¿˜åµŒå¥—ç€å¦ä¸€ä¸ªå¯¹è±¡å±æ€§ï¼Œä½†æˆ‘ä»¬åœ¨è¿™é‡Œå¯ä»¥ç›´æ¥ä½¿ç”¨ `===` è¿›è¡Œæ¯”è¾ƒã€‚No more deep compare !

**ç›´æ¥ä½¿ç”¨ `===` è¿›è¡Œæ¯”è¾ƒçš„å¥½å¤„æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œä¸éœ€è¦æ·±åº¦éå†æ¯”è¾ƒï¼Œå¤§å¤§é™ä½äº† `shouldComponentUpdate` çš„ä¼˜åŒ–æˆæœ¬** ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæ¨èåœ¨ `react` ä¸­ä½¿ç”¨ `immutable data` çš„åŸå› ã€‚

ç„¶è€Œï¼Œ`immutable data` è¿™ä¹ˆå¥½ç”¨ä½†ä¸ä»£è¡¨ä½ ä¸€å®šéœ€è¦å®ƒã€‚å‡è®¾ä½ çš„åº”ç”¨å¤æ‚åº¦ä¸é«˜ï¼Œç»„ä»¶å±‚çº§ä¹Ÿä¸æ·±ï¼Œæ•°æ®ä¹Ÿæ²¡æœ‰é‚£ä¹ˆåºå¤§ï¼Œé‚£å¾€å¾€å¹¶ä¸éœ€è¦ç‰¹æ„å»ä½œ `shouldComponentUpdate` çš„ä¼˜åŒ–ï¼Œ`react` æœ¬èº«å·²ç»è¶³å¤Ÿå¿«äº†ã€‚è¿˜æ˜¯é‚£å¥è¯ï¼Œ**åœ¨æ²¡æœ‰å‡ºç°æ˜æ˜¾çš„æ€§èƒ½é—®é¢˜ä¹‹å‰ï¼Œå¯ä»¥ä¸ä½œä¼˜åŒ–**ã€‚è¿™è®©æˆ‘æƒ³èµ·å‰æ®µæ—¶é—´çœ‹åˆ°çš„ä¸€å¥è¯ï¼Œå¤§æ„æ˜¯è¿™æ ·çš„ï¼š

> å¦‚æœä¸€ä¸ªæ“ä½œå®Œæˆçš„æ—¶é—´å°‘äº `1ms`ï¼Œå½“ä½ ç»ˆäºåŠªåŠ›å°†å®ƒçš„æ•ˆç‡æå‡ `10` å€ä¹‹åï¼Œå®ƒä¾ç„¶åªæ˜¯å°‘äº `1ms`ã€‚

è¿™å½“ç„¶ä¸æ˜¯æ•™æˆ‘ä»¬ä¸éœ€è¦ä¼˜åŒ–æˆ‘ä»¬çš„ä»£ç ã€‚æˆ‘ä¸ªäººçš„ç†è§£æ˜¯ï¼Œ**åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¦è€ƒè™‘ä¼˜åŒ–æˆæœ¬ä¸ä¼˜åŒ–æ•ˆç›Šä¹‹é—´çš„å…³ç³»**ã€‚

`react` é€šå¸¸å¾ˆå¿«ã€‚â€œé€šå¸¸â€çš„æ„æ€æ˜¯ï¼Œä¸éœ€è¦ç‰¹æ„å»ä¼˜åŒ–ï¼Œå®ƒçš„ `virtual dom` ç®—æ³•å°±å¯ä»¥ç»™ä½ ä¸é”™çš„æ€§èƒ½ã€‚ä½†å°±æˆ‘ä¸ªäººä½“ä¼šè€Œè¨€ï¼Œå…¶å®â€œå¿«â€å¹¶ä¸æ˜¯ `react` æœ€å¤§çš„äº®ç‚¹ã€‚å®ƒå°†å‡½æ•°å¼ç†å¿µå¸¦åˆ°äº†å‰ç«¯å¼€å‘ä¹‹ä¸­ï¼Œè®©æˆ‘ä»¬å¯ä»¥ä»ä¸€ä¸ªå…¨æ–°çš„è§’åº¦é‡æ–°å®¡è§†ä½ çš„UIï¼š

{% highlight javascript %}
// ç»„ä»¶å…·æœ‰ç»„åˆæ€§ï¼Œäºæ˜¯ï¼Œå¯ä»¥æŠŠæ•´ä¸ªé¡µé¢å½“ä½œä¸€ä¸ªå¤§ç»„ä»¶
UI = f(state)
{% endhighlight %}

UIä¸å†æ˜¯é›¶é›¶æ•£æ•£ã€ä¸ƒæ‹¼å…«å‡‘èµ·æ¥çš„ä¸€ä¸ªä¸œè¥¿äº†ï¼Œå®ƒæˆä¸ºäº†ä¸€ä¸ªå¯è®¡ç®—çš„å€¼ã€‚åŠ ä¸Š `react` æå€¡çš„å•å‘æ•°æ®æµï¼Œä¿è¯äº†æ•°æ®ï¼ˆçŠ¶æ€ï¼‰ä¸é¡µé¢çš„ä¸€è‡´æ€§ï¼Œä»¥åŠå¯¹æ•°æ®å˜æ›´çš„å¯é¢„æµ‹æ€§ã€‚

---

## å¸¸ç”¨ API

`immutable.js` æä¾›äº†å¤šç§ä¸å¯å˜æ•°æ®ç±»å‹ï¼š`Map`ã€`List`ã€`Set`ç­‰ã€‚è¿™äº›æ•°æ®ç±»å‹å‡å±äº `Iterable` ç±»ï¼ˆå¯è¿­ä»£ï¼‰ã€‚è¿™æ„å‘³ç€ä½ å¯ä»¥åœ¨è¿™å¤šç§æ•°æ®ç±»å‹ä¸Šä½¿ç”¨è¿­ä»£æ–¹æ³•å¦‚ `map` å’Œ `filter` ç­‰ç­‰ã€‚æœ¬æ¥è¿™äº›æ–¹æ³•å¾ˆå¼ºå¤§ï¼Œå´è¢«å±€é™äºåœ¨ `Array` ä¸Šä½¿ç”¨ã€‚

ä¸‹é¢æ˜¯æˆ‘åœ¨å®é™…é¡¹ç›®ä¸­ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„ä¸€äº› `API`ï¼Œä½¿ç”¨ `es6` æ¥ä½œç¤ºèŒƒã€‚å®Œæ•´çš„æ–‡æ¡£[ç‚¹è¿™é‡Œ][doc]ã€‚

- è½¬æ¢åˆ°ä¸å¯å˜æ•°æ®

{% highlight javascript %}
import { fromJS, Map, List } from 'immutable'

// åˆ›å»ºä¸€ä¸ªä¸å¯å˜å¯¹è±¡
const emptyMap = Map()
const notEmptyMap = Map({ name: 'map' })

// Map å¹¶ä¸ä¼šæ·±åº¦è½¬æ¢ä¸€ä¸ªå¯¹è±¡
// è¿™é‡Œçš„ `test` æ˜¯ä¸€ä¸ªä¸å¯å˜æ•°æ®ï¼Œä½†æ˜¯ `a` çš„å±æ€§å€¼ä¾ç„¶æ˜¯æ™®é€šçš„ `javascript` å¯¹è±¡
// æ·±åº¦è½¬æ¢éœ€è¦ä½¿ç”¨ä¸‹é¢çš„ `fromJS`
const test = Map({ a: { b: 1 } } )

// åˆ›å»ºä¸€ä¸ªä¸å¯å˜æ•°ç»„
const emptyList = List()
const notEmptyList = List([0, 1])

// å°†ä¸€ä¸ªå¤æ‚ã€åµŒå¥—çš„æ•°æ®æ¢è½¬
const demo = fromJS({
    a: 1,
    b: ['x', 'y'],
    c: {
        m: {
            name: 'test',
            list: [0, 1, 2]
        },
        n: 'hey'
    }
})
{% endhighlight %}

- è½¬æ¢ä¸ºåŸç”Ÿ `javascript` æ•°æ®

{% highlight javascript %}
import { fromJS, Map } from 'immutable'

// fromJS çš„é€†æ“ä½œæ˜¯ toJS
const immutableData = fromJS({
    a: 0,
    b: {
        list: ['a', 'b']
    }
})

const jsData = immutableData.toJS()

const immutableMap = Map({ a: 1 })
const jsMap = immutableMap.toJS()
{% endhighlight %}

- å–å€¼

{% highlight javascript %}
import { fromJS, Map, List } from 'immutable'

// ç›´æ¥å–å€¼
// get(key: K, notSetValue?: V): V

const a = Map({ name: 'test', title: 'immutable' })

a.get('name') // 'test'
a.get('name2') // undefined
a.get('name3', 'default') // 'default'ï¼Œ æä¾›çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œä¼šåœ¨æŸ¥è¯¢çš„ `key` ä¸å­˜åœ¨æ—¶ï¼Œå½“ä½œè¿”å›å€¼

const b = List([50, 100])

b.get(0) // 50
b.get(1) // 100
b.get(2) // undefined

// å–åˆ°åµŒå¥—åœ¨æ·±å¤„çš„å€¼
// getIn(searchKeyPath: Array<any>, notSetValue?: any)

const c = fromJS({
    a: {
        b: {
            deepKey: 'deepValue'
        },
        c: ['x', 'y', 'z']
    }
})

c.getIn(['a', 'b', 'deepKey']) // 'deepValue'
c.getIn(['a', 'c', 1]) // 'y'
c.getIn(['a', 'd'], 'nothing') // 'nothing'
{% endhighlight %}

- å†™å€¼

{% highlight javascript %}
import { fromJS, List, Map } from 'immutable'

// set(key: K, value: V)
const a = Map()
const b = a.set('name', 'test')
b.get('name') // 'test'

const c = List()
const d = c.set(2, 'test')
d.get(2) // 'test'

// ç»™åµŒå¥—çš„å±æ€§èµ‹å€¼
// setIn(keyPath: Array<any>, value: any)
const x = fromJS({
    a: 'a',
    b: {
        m: 1,
        n: ['x', 'y']
    }
})

const y = x.setIn(['b', 'm'], 2)
y.getIn(['b', 'm']) // 2

const z = x.setIn(['b', 'n', 1], 'yy')
z.getIn(['b', 'n', 1]) // yy
{% endhighlight %}

- åˆ é™¤å±æ€§

{% highlight javascript %}
import { fromJS, Map } from 'immutable'

// delete(key: K)
const a = Map({ x: 1, y: 2 })
const b = a.delete('x')

// { y: 2 }
console.log(b.toJS())

// åˆ é™¤åµŒå¥—åœ¨æ·±å¤„çš„å±æ€§
// deleteIn(keyPath: Array<any>)
const x = fromJS({
    a: 0,
    b: {
        m: 'hello'
    }
})
const y = x.deleteIn(['b', 'm'])
// { a: 0, b: {} }
console.log(y.toJS())
{% endhighlight %}

- æ›´å¸¸ç”¨çš„æ›´æ–°æ•°æ®æ–¹æ³•

{% highlight javascript %}
import { fromJS, Map } from 'immutable'

// update()ï¼Œå®ƒå¯ä»¥æ¥æ”¶1ã€2ã€3ä¸ªå‚æ•°

// ç¬¬ 1 ç§æƒ…å†µï¼Œåªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå‚æ•°ä¸ºä¸€ä¸ªå‡½æ•°(updater)ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ¥æ”¶æ•°æ®æœ¬èº«ä½œä¸ºå‚æ•°
// å‡½æ•°çš„è¿”å›å€¼ï¼Œå³ä¸ºæ›´æ–°è¿‡åçš„å€¼
const a = Map({x: 1, y: 2})
const b = a.update(data => {
    // è¿™é‡Œçš„ `data` å…¶å®å°±æ˜¯æ•°æ® `a` æœ¬èº«
    // åœ¨è¿™é‡Œä½œä¸€åˆ‡ä½ æƒ³è¦çš„æ“ä½œï¼Œæœ€åè®°å¾— return å›å»ä¸€ä¸ªå€¼
    return data
        .delete('x') // åˆ æ‰äº†å±æ€§ `x`
        .set('y', 3) // ä¿®æ”¹äº†å±æ€§ `y`
        .set('z', 4) // è¿˜æ·»åŠ äº†ä¸€ä¸ªæ–°å±æ€§
})
// { y: 3, z: 4 }
console.log(b.toJS())

// ç¬¬ 2 ç§æƒ…å†µï¼Œ2 ä¸ªå‚æ•°
// ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šè¦æ›´æ–°çš„ `key`ï¼Œç¬¬äºŒä¸ªå‚æ•°åŒæ ·æ˜¯ä¸€ä¸ªå‡½æ•°(updater)ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ¥æ”¶å¯¹åº” `key` çš„å€¼ä½œä¸ºå‚æ•°
// å‡½æ•°çš„è¿”å›å€¼ï¼Œä½œä¸ºè¿™ä¸ª `key` æ–°çš„å€¼
const a = Map({x: 1, y: 2})
const b = a.update('x', data => {
    // è¿™é‡Œçš„ `data` ä¸ºå±æ€§ `x` çš„å€¼ï¼š1
    // åœ¨è¿™é‡Œä½œä¸€åˆ‡ä½ æƒ³è¦çš„æ“ä½œï¼Œæœ€åè®°å¾— return å›å»ä¸€ä¸ªå€¼
    return data + 1
})
// { x: 2, y: 2 }
console.log(b.toJS())

// ç¬¬ 3 ç§ï¼Œ3 ä¸ªå‚æ•°
// ç¬¬ 1 ä¸ªå‚æ•°æŒ‡å®šè¦æ›´æ–°çš„ `key`ï¼Œ
// ç¬¬ 2 ä¸ªå‚æ•°æä¾›äº†ä¸€ä¸ªé»˜è®¤å€¼ï¼Œå¦‚æœæŒ‡å®šçš„ `key` ä¸å­˜åœ¨ï¼Œå°±ä½¿ç”¨è¿™ä¸ªå€¼
// ç¬¬ 3 ä¸ªå‚æ•°åŒæ ·æ˜¯ä¸€ä¸ªå‡½æ•°(updater)ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ¥æ”¶å¯¹åº” `key` çš„å€¼ä½œä¸ºå‚æ•°ï¼Œå¦‚æœ `key` ä¸å­˜åœ¨ï¼Œå°±æ¥æ”¶ç¬¬ 2 ä¸ªå‚æ•°æŒ‡å®šçš„å€¼
// å‡½æ•°çš„è¿”å›å€¼ï¼Œä½œä¸ºè¿™ä¸ª `key` æ–°çš„å€¼
const a = Map({x: 1, y: 2})
const b = a.update('z', Map(), data => {
    // è¿™é‡Œçš„ `data` ä¸º Map()ï¼Œå› ä¸º `z` è¿™ä¸ª `key` å¹¶ä¸å­˜åœ¨
    // å¦‚æœä¸æŒ‡å®šç¬¬äºŒä¸ªå‚æ•°ï¼Œé‚£ `data` å°†ä¼šæ˜¯ undefined
    // åœ¨ undefined ä¸Šè°ƒç”¨ `set` æ–¹æ³•æ˜¾ç„¶ä¼šå‡ºé”™ï¼Œæ‰€ä»¥è¿™é‡Œæä¾›ä¸€ä¸ªé»˜è®¤å€¼å°±å¾ˆæœ‰å¿…è¦äº†
    return data.set('a', 1)
})
// { x: 1, y: 2, z: { a: 1 } }
console.log(b.toJS())

/**
 * ä½ åº”è¯¥ä¹ŸçŒœåˆ°äº†ï¼Œç±»ä¼¼ `set` å’Œ `setIn`ï¼Œ`get` å’Œ `getIn`ï¼Œ
 * å¯¹åº”çš„ï¼Œè¿˜æœ‰ä¸€ä¸ª `updateIn`
 * å®ƒçš„ç¬¬ 1 ä¸ªå‚æ•°æŒ‡å®šäº† `key` çš„è·¯å¾„ï¼Œå¿…é¡»ä¸ºæ•°ç»„
 */
const a = fromJS({
    x: 1,
    y: 2,
    z: {
        list: [
            { a: 0, b: 1 }
        ]
    }
})
const b = a.updateIn(['z', 'list', 0, 'b'], data => {
    // `data` ä¸º 1
    return data * 2
})
// b.toJS() çš„ç»“æœä¸ºï¼š
{
    x: 1,
    y: 2,
    z: {
        list: [
            { a: 0, b: 2 }
        ]
    }
}
{% endhighlight %}

- å¼ºå¤§çš„éå†æ–¹æ³•

{% highlight javascript %}
import { Map } from 'immutable'

const a = Map({
    a: 1,
    b: 2,
    c: 'test'
})

const b = a.map((val, key) => {
    return '-' + value
})

// b.toJS() çš„ç»“æœä¸º
{
    a: '-1',
    b: '-2',
    c: '-test'
}

const c = a.filter(val => {
    return typeof value === 'number'
})

// c.toJS() çš„ç»“æœä¸º
{
    a: 1,
    b: 2
}
{% endhighlight %}

ä»¥ä¸Šä»…ä»…æ˜¯ `immutable.js` ä¼—å¤š `API` ä¸­çš„ä¸€éƒ¨åˆ†ã€‚å®ƒçš„ `API` è™½å¤šï¼Œä½†è®¾è®¡å¾—å¾ˆå·§å¦™ï¼Œä¹Ÿéå¸¸è¯­ä¹‰åŒ–ï¼Œæ¥å—èµ·æ¥å¹¶ä¸éš¾ã€‚æ›´å¯è´µçš„æ˜¯å®ƒæä¾›çš„ä¸€ç³»åˆ—éå†æ–¹æ³•å¾€å¾€å¯ä»¥é™ä½æˆ‘ä»¬è§£å†³ä¸€äº›é—®é¢˜çš„å¤æ‚åº¦ã€‚




[lee's twitter]: https://twitter.com/leeb
[graphql]: https://github.com/graphql/graphql-js
[doc]: http://facebook.github.io/immutable-js/docs/
[wiki]: https://en.wikipedia.org/wiki/Persistent_data_structure
